<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Wedding! å—ä»˜ã‚¢ãƒ—ãƒª</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (M PLUS Rounded 1c) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Tailwindã®ã‚«ã‚¹ã‚¿ãƒ è¨­å®š */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FFF9FB; /* ã‚µãƒ³ãƒªã‚ªé¢¨ã®è–„ã„ãƒ”ãƒ³ã‚¯èƒŒæ™¯ */
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¤ã¤ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å¯èƒ½ã«ã™ã‚‹ï¼ˆiPadé¢¨ï¼‰ */
        ::-webkit-scrollbar {
            display: none;
        }
        /* å‡ºå¸­æ¸ˆã¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .attended {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .attended::after {
            content: ' âœ…';
        }
        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ */
        .hidden-page {
            display: none;
        }
        /* AIãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .ai-button:hover:not(:disabled) {
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.6);
        }

        /* --- ã‚«ã‚¹ã‚¿ãƒ : ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ç¸®å°ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨­å®š --- */
        /* ç”»é¢2ã®ç”»åƒ */
        #list-character-image {
            /* 80%ã«ç¸®å°ã—ã€Yè»¸ï¼ˆä¸‹æ–¹å‘ï¼‰ã«8pxç§»å‹•ï¼ˆTailwindã®translate-y-2ã«ç›¸å½“ï¼‰ */
            transform: rotate(2deg) scale(0.8) translateY(0.5rem); 
        }
        /* ç”»é¢1ã®ç”»åƒï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³å†…ï¼‰ */
        .table-character-image {
             /* ç”»é¢2ã¨åŒã˜è¨­å®šã‚’é©ç”¨ */
            transform: rotate(2deg) scale(1) translateY(0.5rem); 
        }
        /* ------------------------------------------------ */
        
        /* --- ã‚«ã‚¹ã‚¿ãƒ : å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .completion-checkmark {
            position: absolute;
            top: -10px; /* å°‘ã—ä¸Šã«ãšã‚‰ã™ */
            right: -10px; /* å°‘ã—å³ã«ãšã‚‰ã™ */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #10B981; /* ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 10;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€éã•ã›ã‚‹ */
        }

        /* ç”»é¢2ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ã‚’ä¸Šã«å¯„ã›ã‚‹ãŸã‚ã®èª¿æ•´ */
        .list-header-top {
            margin-bottom: -50px; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã¨ã®é‡ãªã‚Šã‚’è€ƒæ…®ã—ã¦èª¿æ•´ */
        }

    </style>
</head>
<body class="antialiased text-gray-800 min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- ç”»é¢1: ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠç”»é¢ -->
        <div id="page-home">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-extrabold text-pink-500" style="text-shadow: 1px 1px 2px #ffe4e6;">
                    ğŸŒ¸ Lukas & Reika's Wedding ğŸŒ¸
                </h1>
                <p class="text-lg md:text-xl text-pink-400 mt-2">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãˆã‚‰ã‚“ã§ãã ã•ã„</p>
            </header>

            <!-- æ¤œç´¢æ©Ÿèƒ½ -->
            <div class="mb-8 p-3 bg-white rounded-2xl shadow-lg">
                <input type="text" id="guest-search-input" placeholder="æ°åã§æ¤œç´¢ (ä¾‹: ç”°æ‘)"
                       class="w-full text-lg p-3 rounded-xl border-2 border-pink-100 focus:ring-pink-400 focus:border-pink-400 font-medium">
            </div>
            <div id="search-result-area" class="mb-8 hidden">
                <p class="text-lg font-semibold text-gray-700 mb-2">ğŸ” æ¤œç´¢çµæœ:</p>
                <div id="search-result-list" class="space-y-3">
                    <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <button id="clear-search-button" class="mt-4 text-sm text-pink-500 hover:text-pink-700 font-bold p-2">æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢</button>
            </div>
            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã‚°ãƒªãƒƒãƒ‰ (iPadå‘ã‘ã«æœ€é©åŒ–) -->
            <div id="table-selection-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
                <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã¯JSã«ã‚ˆã£ã¦ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
            
            <!-- âœ¨ Gemini API æ©Ÿèƒ½ã‚¨ãƒªã‚¢ (ç”»é¢1ã®æœ€ä¸‹éƒ¨ã«é…ç½® - å¸¸ã«æœ‰åŠ¹)
            <div id="gemini-api-area" class="mt-12 border-t-2 border-pink-200 pt-8 text-center">
                <p class="text-xl font-bold text-pink-600 mb-4">å—ä»˜ãƒˆãƒ¼ã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆï¼</p>
                <div class="p-6 bg-white rounded-2xl shadow-lg border-2 border-pink-100">
                    <button id="generate-talk-button"
                            class="ai-button text-xl font-extrabold text-white bg-pink-500 rounded-full px-8 py-4 shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                        ğŸ€ ãƒ†ãƒ¼ãƒãƒˆãƒ¼ã‚¯ã‚’ç”Ÿæˆ
                    </button>
                    <div id="talk-result-area" 
                         class="hidden mt-6 p-5 bg-pink-50 rounded-xl shadow-inner text-gray-700 text-lg min-h-[50px] text-left border-2 border-pink-200">
                        AIã«ã‚ˆã‚‹ç”ŸæˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
            </div>
            ã“ã“ã¾ã§ -->
        </div>

        <!-- ç”»é¢2: å‡ºå¸­è€…ãƒªã‚¹ãƒˆç”»é¢ -->
        <!-- NOTE: èƒŒæ™¯è‰²ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã€ã‚·ãƒ£ãƒ‰ã‚¦ã¯JSã§å‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ -->
        <div id="page-list" class="hidden-page">
            
            <header class="mb-8">
                <!-- 1. æˆ»ã‚‹ãƒœã‚¿ãƒ³/ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ/ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’æ¨ªä¸¦ã³ã§é…ç½® (ä¸Šå¯„ã›) -->
                <div class="flex items-start justify-between list-header-top">
                    <!-- å·¦: æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
                    <button id="back-button-list" class="text-lg text-pink-600 hover:text-pink-800 transition-colors duration-200 font-bold p-2 rounded-xl bg-white shadow-lg transform hover:scale-105 active:scale-95">
                        &larr; ã‚‚ã©ã‚‹
                    </button> 
                    
                    <!-- ä¸­å¤®: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ -->
                    <div class="absolute left-1/2 transform -translate-x-1/2 -top-0.5">
                        <img id="list-character-image" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" 
                             class="w-36 h-36 md:w-48 md:h-48 object-contain rounded-3xl shadow-xl border-4 border-white mx-auto">
                    </div>
                    
                    <!-- å³: ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ± -->
                    <div class="text-right">
                        <h2 id="list-table-id" class="text-2xl md:text-3xl font-extrabold text-pink-600">
                            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ID (ä¾‹: 1-1) -->
                        </h2>
                        <p class="text-lg text-gray-500">ã®çš†ã•ã¾</p>
                    </div>
                </div>
                
                <!-- 2. ã‚¹ãƒšãƒ¼ã‚µãƒ¼/ãƒªã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ (ç”»åƒãŒæµ®ã„ã¦ã„ã‚‹ãŸã‚ã€ãƒªã‚¹ãƒˆé–‹å§‹ä½ç½®ã‚’èª¿æ•´) -->
                <div class="pt-28 md:pt-32">
                    <h3 class="text-xl font-extrabold text-pink-500 border-b-2 border-pink-300 pb-2 mb-4">å‡ºå¸­è€…ãƒªã‚¹ãƒˆ</h3>
                </div>
            </header>

            <!-- å‡ºå¸­è€…ãƒªã‚¹ãƒˆ -->
            <ul id="guest-list-ul" class="space-y-3">
                <!-- å‡ºå¸­è€…ãƒªã‚¹ãƒˆã¯JSã«ã‚ˆã£ã¦ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </ul>
            
            <!-- ç¢ºå®šãƒœã‚¿ãƒ³ -->
            <div class="mt-8 text-center">
                <button id="confirm-button" class="text-2xl font-extrabold text-white bg-green-500 rounded-full px-10 py-4 shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                    å—ä»˜ ç¢ºå®š
                </button>
            </div>

        </div>

    </div>

    <script>
        // --- 5. çµ„ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ ---
        const appData = {
            "guestList": [
                { "id": 1, "name": "ç”°æ‘ å…‰", "table": "1-1" },
                { "id": 2, "name": "ä¸­æ‘ åœ­è¼”", "table": "1-1" },
                { "id": 3, "name": "è—¤é‡ æº–ä¹Ÿ", "table": "1-1" },
                { "id": 4, "name": "æ£®å±± å‹‡ä»‹", "table": "1-1" },
                { "id": 5, "name": "æ£®å±± ç†ç´—", "table": "1-1" },
                { "id": 6, "name": "ä¸Šå²¡ å…‰", "table": "1-2" },
                { "id": 7, "name": "ä¸Šç•‘ æ—¥èœä¹ƒ", "table": "1-2" },
                { "id": 8, "name": "é¶´å²¡ ç¾ç·’", "table": "1-2" },
                { "id": 9, "name": "å¯ºå· è²´å¼˜", "table": "1-2" },
                { "id": 10, "name": "å¶‹ç”° å’²ç´€", "table": "1-3" },
                { "id": 11, "name": "å…­äººéƒ¨ ã‚ã‚†ã¿", "table": "1-3" },
                { "id": 12, "name": "ä¸­å²¡ å¤©éŸ³", "table": "1-3" },
                { "id": 13, "name": "å°æ£® æœªæœ‰å¸Œ", "table": "1-3" },
                { "id": 14, "name": "éˆ´æœ¨ ç´—ç·’é‡Œ", "table": "1-3" },
                { "id": 15, "name": "ç‰§é‡ é‚£æœˆ", "table": "1-3" },
                { "id": 16, "name": "ä¸Šå²¡ å¿ å‰‡", "table": "2-1" },
                { "id": 17, "name": "ä¸Šå²¡ ã•ãå­", "table": "2-1" },
                { "id": 18, "name": "ä¸Šå²¡ çœŸç†", "table": "2-1" },
                { "id": 19, "name": "æ­¦ç”° ãƒã‚¦ãƒ­", "table": "2-1" },
                { "id": 20, "name": "ä¸Šå²¡ å„ªæ˜", "table": "2-1" },
                { "id": 21, "name": "ç”Ÿç”° è“®ç¿”", "table": "2-1" },
                { "id": 22, "name": "ä»²é‡Œ ã‚°ã‚¹ã‚¿ãƒœ", "table": "2-1" },
                { "id": 23, "name": "ä¸­èŠ ç”±è²´å­", "table": "2-2" },
                { "id": 24, "name": "ä¸­èŠ ç´”å­", "table": "2-2" },
                { "id": 25, "name": "ä¸­èŠ è™¹ç©º", "table": "2-2" },
                { "id": 26, "name": "å±±ï¨‘ é–ä»£", "table": "2-2" },
                { "id": 27, "name": "ä¸­èŠ å‡Œ", "table": "2-2" },
                { "id": 28, "name": "ä¸­èŠ æ„›é‡Œ", "table": "2-2" },
                { "id": 29, "name": "ç‰‡å±± è£•æ¨¹", "table": "2-2" }
            ],
            "tableDetails": [
                { "tableId": "1-1", "characterImageUrl": "https://sweeet0.github.io/wedding/IMG_7058.PNG", "themeColor": "bg-purple-200", "textColor": "text-purple-700" }, 
                { "tableId": "1-2", "characterImageUrl": "https://sweeet0.github.io/wedding/IMG_7063.PNG", "themeColor": "bg-yellow-200", "textColor": "text-yellow-700" },
                { "tableId": "1-3", "characterImageUrl": "https://sweeet0.github.io/wedding/IMG_7059.PNG", "themeColor": "bg-blue-200", "textColor": "text-blue-700" },
                { "tableId": "2-1", "characterImageUrl": "https://sweeet0.github.io/wedding/IMG_7060.PNG", "themeColor": "bg-pink-200", "textColor": "text-pink-700" },
                { "tableId": "2-2", "characterImageUrl": "https://sweeet0.github.io/wedding/IMG_7066.PNG", "themeColor": "bg-orange-200", "textColor": "text-orange-700" } 
            ]
        };

        // --- DOMè¦ç´  ---
        const pageHome = document.getElementById('page-home');
        const pageList = document.getElementById('page-list');
        const tableSelectionGrid = document.getElementById('table-selection-grid');
        const guestListUl = document.getElementById('guest-list-ul');
        const backButtonList = document.getElementById('back-button-list'); // ç”»é¢2ã®ã€Œã‚‚ã©ã‚‹ã€ãƒœã‚¿ãƒ³
        const listTableId = document.getElementById('list-table-id');
        const listCharacterImage = document.getElementById('list-character-image');
        const guestSearchInput = document.getElementById('guest-search-input');
        const searchResultArea = document.getElementById('search-result-area');
        const searchResultList = document.getElementById('search-result-list');
        const clearSearchButton = document.getElementById('clear-search-button');
        
        // AIã‚¨ãƒªã‚¢ã®è¦ç´ 
        const generateTalkButton = document.getElementById('generate-talk-button');
        const talkResultArea = document.getElementById('talk-result-area');

        // ç¢ºå®šãƒœã‚¿ãƒ³
        const confirmButton = document.getElementById('confirm-button');


        // --- å‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ (localStorage) ---
        let attendanceState = JSON.parse(localStorage.getItem('weddingAttendance')) || {};

        function saveState() {
            localStorage.setItem('weddingAttendance', JSON.stringify(attendanceState));
        }

        /**
         * ç‰¹å®šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚²ã‚¹ãƒˆå…¨å“¡ãŒãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿ã‹ã‚’ç¢ºèªã™ã‚‹
         */
        function isTableComplete(tableId) {
            const guestsForTable = appData.guestList.filter(g => g.table === tableId);
            if (guestsForTable.length === 0) return false; 
            return guestsForTable.every(guest => {
                const guestKey = `guest-${guest.id}`;
                return attendanceState[guestKey] === true;
            });
        }


        // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
        function showPage(pageId) {
            if (pageId === 'home') {
                pageHome.classList.remove('hidden-page');
                pageList.classList.add('hidden-page');
                
                // AIã‚¨ãƒªã‚¢ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆãƒœã‚¿ãƒ³ã¯å¸¸ã«æœ‰åŠ¹ãªã®ã§ã€çµæœè¡¨ç¤ºã®ã¿éè¡¨ç¤ºã«ï¼‰
                talkResultArea.classList.add('hidden');
                talkResultArea.innerHTML = '';

                renderHomeScreen(); // çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’å†æç”»
                clearSearch(); // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹éš›ã€æ¤œç´¢çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            } else if (pageId === 'list') {
                pageHome.classList.add('hidden-page');
                pageList.classList.remove('hidden-page');
                
                // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ç”»é¢2ã‚’é–‹ãã¨ãã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…
                window.scrollTo(0, 0);
            }
        }

        // --- ç”»é¢æç”» ---

        // ç”»é¢1: ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠç”»é¢ã®æç”»
        function renderHomeScreen() {
            tableSelectionGrid.innerHTML = ''; 
            
            appData.tableDetails.forEach((table) => {
                const button = document.createElement('button');
                const colorClass = table.themeColor; 
                const textColor = table.textColor;

                button.className = `p-6 rounded-3xl shadow-xl transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95 ${colorClass} relative`;
                button.dataset.tableId = table.tableId; 

                // å®Œäº†ãƒã‚§ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯
                const isComplete = isTableComplete(table.tableId);
                const checkmarkHtml = isComplete ? '<div class="completion-checkmark">âœ“</div>' : '';

                button.innerHTML = `
                    ${checkmarkHtml}
                    <img src="${table.characterImageUrl}" alt="${table.tableId}" 
                         class="table-character-image w-full h-32 md:h-40 object-contain rounded-2xl mb-4 border-4 border-white shadow-md"
                         onerror="this.src='https://placehold.co/150x150/cccccc/333333?text=Image+Error'; this.onerror=null;">
                    <span class="text-2xl md:text-3xl font-extrabold ${textColor}">${table.tableId}</span>
                `;

                button.addEventListener('click', () => {
                    renderListPage(table.tableId);
                });
                tableSelectionGrid.appendChild(button);
            });
        }

        // ç”»é¢2: å‡ºå¸­è€…ãƒªã‚¹ãƒˆç”»é¢ã®æç”»
        function renderListPage(tableId) {
            const tableInfo = appData.tableDetails.find(t => t.tableId === tableId);
            if (!tableInfo) return;

            // --- ğŸ¨ ç”»é¢2ã®èƒŒæ™¯è‰²ã‚’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®è–„ã„è‰²ã«å¤‰æ›´ ---
            const themeColorClass = tableInfo.themeColor; 
            const listBgClass = themeColorClass.replace(/-\d+/, '-50'); 

            pageList.classList.forEach(cls => {
                if (cls.match(/^bg-.*-50$/)) {
                    pageList.classList.remove(cls);
                }
            });

            // position-relativeã‚’è¿½åŠ ã—ã€çµ¶å¯¾ä½ç½®ã®ç”»åƒã‚’å†…åŒ…ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            pageList.classList.add(listBgClass, 'p-6', 'rounded-3xl', 'shadow-xl', 'relative'); 
            // ----------------------------------------------------


            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±æ›´æ–°
            listTableId.textContent = tableId;
            listCharacterImage.src = tableInfo.characterImageUrl;
            listCharacterImage.alt = tableInfo.tableId;
            listCharacterImage.onerror = () => {
                listCharacterImage.src = 'https://placehold.co/150x150/cccccc/333333?text=Image+Error';
                listCharacterImage.onerror = null;
            };

            // å‡ºå¸­è€…ãƒªã‚¹ãƒˆæ›´æ–°
            guestListUl.innerHTML = ''; 
            const guestsForTable = appData.guestList.filter(g => g.table === tableId);

            if (guestsForTable.length === 0) {
                guestListUl.innerHTML = '<li class="text-center text-gray-500 text-lg p-4 bg-white rounded-xl shadow-sm">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚²ã‚¹ãƒˆã¯ã„ã¾ã›ã‚“</li>';
            }

            guestsForTable.forEach(guest => {
                const li = document.createElement('li');
                const guestKey = `guest-${guest.id}`;
                
                // iPadã‚¿ãƒƒãƒ—ã«æœ€é©åŒ–
                li.className = "text-xl md:text-2xl p-4 bg-white rounded-xl shadow-md cursor-pointer transition-colors duration-200 font-medium hover:bg-pink-50 active:bg-pink-100";
                li.textContent = guest.name;
                li.dataset.guestId = guest.id;

                // ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ã‚’åæ˜ 
                if (attendanceState[guestKey]) {
                    li.classList.add('attended');
                }

                // ã‚¯ãƒªãƒƒã‚¯ã§å‡ºæ¬ ãƒˆã‚°ãƒ«
                li.addEventListener('click', () => {
                    const currentState = attendanceState[guestKey] || false;
                    attendanceState[guestKey] = !currentState; 
                    li.classList.toggle('attended', attendanceState[guestKey]);
                    saveState(); 
                });

                guestListUl.appendChild(li);
            });

            // ç”»é¢è¡¨ç¤º
            showPage('list');
        }
        
        // --- æ¤œç´¢æ©Ÿèƒ½ ---
        guestSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length < 1) {
                clearSearch();
                return;
            }

            const results = appData.guestList.filter(guest => guest.name.toLowerCase().includes(query.toLowerCase()));
            renderSearchResults(results);
        });

        clearSearchButton.addEventListener('click', clearSearch);

        function clearSearch() {
            searchResultArea.classList.add('hidden');
            searchResultList.innerHTML = '';
            guestSearchInput.value = '';
            tableSelectionGrid.classList.remove('hidden');
        }

        function renderSearchResults(results) {
            searchResultList.innerHTML = '';
            
            if (results.length === 0) {
                searchResultList.innerHTML = '<p class="text-red-500 p-3 bg-white rounded-xl shadow-sm">è©²å½“ã™ã‚‹ã‚²ã‚¹ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            } else {
                results.forEach(guest => {
                    const li = document.createElement('div');
                    const guestKey = `guest-${guest.id}`;
                    
                    li.className = "text-xl p-4 bg-white rounded-xl shadow-md cursor-pointer transition-colors duration-200 font-medium hover:bg-pink-50 active:bg-pink-100";
                    li.innerHTML = `${guest.name} <span class="text-sm text-gray-500 ml-2">[${guest.table}]</span>`;
                    
                    if (attendanceState[guestKey]) {
                        li.classList.add('attended');
                    }

                    // ã‚¯ãƒªãƒƒã‚¯ã§å‡ºæ¬ ãƒˆã‚°ãƒ«
                    li.addEventListener('click', () => {
                        const currentState = attendanceState[guestKey] || false;
                        attendanceState[guestKey] = !currentState;
                        li.classList.toggle('attended', attendanceState[guestKey]);
                        saveState();
                        // çŠ¶æ…‹å¤‰æ›´å¾Œã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒªã‚¹ãƒˆç”»é¢ã¸é·ç§»
                        renderListPage(guest.table);
                    });

                    searchResultList.appendChild(li);
                });
            }
            tableSelectionGrid.classList.add('hidden');
            searchResultArea.classList.remove('hidden');
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        
        // ç”»é¢2ã€Œã‚‚ã©ã‚‹ã€ãƒœã‚¿ãƒ³: ãƒ›ãƒ¼ãƒ ç”»é¢ã¸æˆ»ã‚‹
        backButtonList.addEventListener('click', () => {
            showPage('home');
        });
        
        // ç”»é¢2ã€Œç¢ºå®šã€ãƒœã‚¿ãƒ³: ãƒ›ãƒ¼ãƒ ç”»é¢ã¸æˆ»ã‚‹
        confirmButton.addEventListener('click', () => {
            showPage('home');
        });

        // Gemini API ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ç”»é¢1)
        generateTalkButton.addEventListener('click', handleGenerateTalk);


        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            renderHomeScreen();
            showPage('home');
        });

        // --- Gemini API æ©Ÿèƒ½ ---
        const apiKey = "AIzaSyADzIMS_uTImpYqJPc4-y4GapoenOTQzls"; 

        /**
         * æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ãƒ•ã‚§ãƒƒãƒãƒ©ãƒƒãƒ‘ãƒ¼
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        /**
         * Gemini APIã‚’å‘¼ã³å‡ºã—ã€AIã«ã‚ˆã‚‹ä¼šè©±ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã™ã‚‹
         */
        async function callGeminiApi(systemPrompt, userPrompt) {
            // gemini-2.5-flash-preview-09-25 is an alias for gemini-2.5-flash-preview-09-2025
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-25:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚");
                }
            } catch (error) {
                talkResultArea.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: AIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`; 
                console.error("Gemini API Call Failed:", error);
                throw new Error("AIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        /**
         * ã€Œãƒ†ãƒ¼ãƒãƒˆãƒ¼ã‚¯ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† (ãƒ†ãƒ¼ãƒ–ãƒ«éä¾å­˜)
         */
        async function handleGenerateTalk(event) {
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–° (ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹)
            event.currentTarget.disabled = true;
            event.currentTarget.classList.remove('bg-pink-500', 'hover:scale-105');
            event.currentTarget.classList.add('bg-pink-300', 'cursor-not-allowed');

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            talkResultArea.innerHTML = '<span class="text-pink-500 animate-pulse font-bold">è€ƒãˆä¸­... ğŸ€</span>';
            talkResultArea.classList.remove('hidden');

            // AIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šï¼ˆä¸€èˆ¬çš„ãªçµå©šå¼ã®ãƒ†ãƒ¼ãƒãƒˆãƒ¼ã‚¯ï¼‰
            const systemPrompt = `ã‚ãªãŸã¯ã‚µãƒ³ãƒªã‚ªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚ˆã†ãªã€ã¨ã¦ã‚‚è¦ªåˆ‡ã§å¯æ„›ã‚‰ã—ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚çµå©šå¼ã®ã‚¢ã‚¤ã‚¹ãƒ–ãƒ¬ã‚¤ã‚¯ã‚’æ‰‹ä¼ã£ã¦ã„ã¾ã™ã€‚æ˜ã‚‹ãã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ã€çµµæ–‡å­—ã‚’ãŸãã•ã‚“ä½¿ã£ãŸçŸ­ã„ï¼ˆ2ã€œ3æ–‡ï¼‰ã®ãƒ†ãƒ¼ãƒãƒˆãƒ¼ã‚¯ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;
            const userPrompt = `çµå©šå¼ã®å—ä»˜ã§ã€ã‚²ã‚¹ãƒˆåŒå£«ã‚„ã‚¹ã‚¿ãƒƒãƒ•ã¨ã®é–“ã«ã™ãã«ç¬‘é¡”ãŒç”Ÿã¾ã‚Œã‚‹ã‚ˆã†ãªã€èª°ã«ã§ã‚‚æ°—è»½ã«è©±ã›ã‚‹ãƒ†ãƒ¼ãƒãƒˆãƒ¼ã‚¯ã®ã€ŒãŠé¡Œã€ã‚’1ã¤ã ã‘ææ¡ˆã—ã¦ãã ã•ã„ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã«ä¾å­˜ã—ãªã„ã€ä¸€èˆ¬çš„ãªè©±é¡Œã§ãŠé¡˜ã„ã—ã¾ã™ã€‚`;

            try {
                const generatedText = await callGeminiApi(systemPrompt, userPrompt);
                // æ”¹è¡Œã‚’HTMLã®<br>ã«å¤‰æ›ã—ã¦è¡¨ç¤º
                talkResultArea.innerHTML = generatedText.replace(/\n/g, '<br>');
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯ callGeminiApi å†…éƒ¨ã§å‡¦ç†æ¸ˆã¿
            } finally {
                // å‡¦ç†å®Œäº†å¾Œã€ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                event.currentTarget.disabled = false;
                event.currentTarget.classList.remove('bg-pink-300', 'cursor-not-allowed');
                event.currentTarget.classList.add('bg-pink-500', 'hover:scale-105');
            }
        }

    </script>
</body>

</html>

